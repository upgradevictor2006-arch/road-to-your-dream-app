import asyncio
import os
from openai import AsyncOpenAI
from dotenv import load_dotenv
import logging
import httpx

# Загружаем переменные окружения
load_dotenv()

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class AIAgent:
    """AI-модуль для генерации мотивационных сообщений (OpenAI версия)"""
    
    def __init__(self):
        """Инициализация AI-агента"""
        self.api_key = os.getenv('OPENAI_API_KEY')
        
        if not self.api_key:
            raise ValueError("OPENAI_API_KEY не найден в .env файле!")
        
        # Настройки прокси для OpenAI
        proxy_url = os.getenv('PROXY_URL')
        
        # Создаем клиент OpenAI с прокси (только для OpenAI)
        if proxy_url:
            # Создаем HTTP-клиент с прокси ТОЛЬКО для OpenAI
            http_client = httpx.AsyncClient(
                proxy=proxy_url,  # Используем оригинальный URL
                timeout=30.0
            )
            self.client = AsyncOpenAI(
                api_key=self.api_key,
                http_client=http_client
            )
        else:
            self.client = AsyncOpenAI(api_key=self.api_key)
        
        # Системный промпт для AI-попутчика
        self.system_prompt = (
            "Ты — AI-попутчик в приложении для достижения целей. "
            "Ты позитивный и используешь метафоры путешествий. "
            "Используй образы дороги, путешествия, восхождения на гору, плавания по морю. "
            "Будь вдохновляющим, но не слишком длинным (2-3 предложения). "
            "Пиши на русском языке."
        )
    
    async def get_ai_motivation(self, event: str) -> str:
        """
        Генерирует мотивационное сообщение в зависимости от события
        
        Args:
            event (str): Тип события (например, '7_days_streak', 'first_goal', 'milestone_reached')
            
        Returns:
            str: Мотивационное сообщение от AI
        """
        try:
            # Генерируем пользовательский промпт в зависимости от события
            user_prompt = self._generate_user_prompt(event)
            
            # Отправляем запрос к GPT-3.5-turbo
            response = await self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                max_tokens=150,
                temperature=0.8
            )
            
            # Извлекаем и возвращаем ответ
            motivation_text = response.choices[0].message.content.strip()
            logger.info(f"Сгенерировано мотивационное сообщение для события: {event}")
            
            return motivation_text
            
        except Exception as e:
            logger.error(f"Ошибка при генерации мотивации: {e}")
            return self._get_fallback_motivation(event)
    
    def _generate_user_prompt(self, event: str) -> str:
        """Генерирует пользовательский промпт в зависимости от события"""
        
        event_prompts = {
            '7_days_streak': (
                "Пользователь уже 7 дней подряд работает над своими целями! "
                "Это серьезное достижение. Напиши мотивационное сообщение, "
                "используя метафоры путешествия и дороги."
            ),
            'first_goal': (
                "Пользователь поставил свою первую цель в приложении! "
                "Это начало пути. Напиши вдохновляющее сообщение, "
                "используя метафоры начала путешествия."
            ),
            'milestone_reached': (
                "Пользователь достиг важной вехи в своем путешествии к цели! "
                "Напиши поздравление, используя метафоры достижения вершины или "
                "достижения важной точки на карте."
            ),
            'goal_completed': (
                "Пользователь успешно завершил свою цель! "
                "Это финишная черта. Напиши поздравление, "
                "используя метафоры завершения путешествия."
            ),
            'motivation_needed': (
                "Пользователь просит мотивации для продолжения работы над целями. "
                "Напиши вдохновляющее сообщение, используя метафоры дороги и путешествия."
            ),
            'weekly_review': (
                "Пользователь завершил неделю работы над целями. "
                "Это как завершение этапа путешествия. "
                "Подведи итоги и вдохнови на следующую неделю."
            )
        }
        
        return event_prompts.get(event, 
            f"Пользователь достиг события: {event}. "
            "Напиши мотивационное сообщение, используя метафоры путешествия и дороги."
        )
    
    def _get_fallback_motivation(self, event: str) -> str:
        """Возвращает запасное мотивационное сообщение при ошибке API"""
        
        import random
        
        # Расширенная база fallback сообщений с несколькими вариантами для каждого события
        fallback_messages = {
            '7_days_streak': [
                "Неделя подряд! Ты как опытный путешественник, который знает дорогу. Продолжай идти к своей мечте!",
                "Семь дней подряд - это серьезное достижение! Ты как караван, который не останавливается. Вперед!",
                "Неделя упорства! Ты как корабль, который нашел свой курс. Плыви к своей мечте!",
                "Семь дней пути! Ты как проводник, который ведет себя к цели. Не сворачивай с дороги!"
            ],
            'first_goal': [
                "Твой путь начинается! Каждое великое путешествие начинается с первого шага. Вперед к мечте!",
                "Первая цель достигнута! Ты как исследователь, который нашел первую тропу. Продолжай открывать новые горизонты!",
                "Начало положено! Ты как мореплаватель, который отправился в плавание. Плыви к своей мечте!",
                "Первый шаг сделан! Ты как альпинист, который начал восхождение. Поднимайся к вершине!"
            ],
            'milestone_reached': [
                "Ты достиг важной вехи! Как альпинист на смотровой площадке - видишь, как далеко зашел. Не останавливайся!",
                "Важная веха пройдена! Ты как путешественник на перевале - видишь весь пройденный путь. Вперед к новым высотам!",
                "Отличная работа! Ты как караван, достигший оазиса. Отдохни и продолжай путь к мечте!",
                "Веха достигнута! Ты как мореплаватель, который нашел остров. Исследуй новые земли!"
            ],
            'goal_completed': [
                "Пункт назначения достигнут! Ты успешно завершил этап своего путешествия. Время ставить новые цели!",
                "Цель выполнена! Ты как путешественник, который добрался до города. Планируй следующее приключение!",
                "Отлично! Ты как исследователь, который нашел сокровище. Ищи новые цели для покорения!",
                "Поздравляю! Ты как альпинист, который взошел на вершину. Спускайся и покоряй новые горы!"
            ],
            'motivation_needed': [
                "Каждый путешественник проходит через трудные участки. Помни: за каждым холмом открывается новая дорога!",
                "Трудный участок пути? Ты как караван в пустыне - знаешь, что за дюнами ждет оазис. Не останавливайся!",
                "Сложно? Ты как мореплаватель в шторме - знаешь, что за бурей ждет спокойное море. Плыви дальше!",
                "Тяжело? Ты как альпинист на крутом склоне - знаешь, что за подъемом ждет прекрасный вид. Карабкайся выше!"
            ],
            'weekly_review': [
                "Неделя завершена! Ты прошел еще один этап своего пути. Время планировать следующую неделю приключений!",
                "Неделя подошла к концу! Ты как путешественник, который завершил главу своего дневника. Пиши новую главу!",
                "Неделя пройдена! Ты как караван, который добрался до станции. Отдохни и планируй следующий переход!",
                "Неделя завершена! Ты как мореплаватель, который причалил к берегу. Планируй новое плавание!"
            ]
        }
        
        # Получаем список сообщений для события или общий список
        messages = fallback_messages.get(event, [
            "Твой путь к мечте продолжается! Каждый шаг приближает тебя к цели. Не останавливайся!",
            "Ты на правильном пути! Как путешественник, который знает направление. Иди к своей мечте!",
            "Продолжай движение! Ты как караван, который не останавливается. Вперед к цели!",
            "Твой путь продолжается! Каждый день - это новый шаг к мечте. Не сдавайся!"
        ])
        
        # Возвращаем случайное сообщение из списка
        return random.choice(messages)

# Глобальный экземпляр AI-агента (создается только при необходимости)
ai_agent = None

def get_ai_agent():
    """Получает экземпляр AI-агента, создает его при необходимости"""
    global ai_agent
    if ai_agent is None:
        try:
            ai_agent = AIAgent()
        except ValueError:
            # Если нет API-ключа, возвращаем None
            return None
    return ai_agent

# Асинхронная функция для удобного использования
async def get_ai_motivation(event: str) -> str:
    """
    Асинхронная функция для получения мотивационного сообщения
    
    Args:
        event (str): Тип события
        
    Returns:
        str: Мотивационное сообщение
    """
    agent = get_ai_agent()
    if agent is None:
        # Если нет API-ключа, возвращаем fallback
        fallback_agent = AIAgent()
        return fallback_agent._get_fallback_motivation(event)
    
    return await agent.get_ai_motivation(event)

